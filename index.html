<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Tank</title>
</head>
<body>
	<div id="tank">
		<div class="gun"></div>
	</div>
</body>
<style type="text/css">
	*{
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}
	body{
		height: 100vh;
		overflow: hidden;
	}
	.enemy{
		height: 80px;
		width: 80px;
		position: absolute;
		border: 1px solid black;
		background: red;
	}
	#tank{
		height: 60px;
		width: 60px;
		position: absolute;
	}
		#tank .gun{
			box-sizing: border-box;
			height: 40px;
			width: 30px;
			background: #9e9e9e;
			border: 2px solid #4d4f4f;
			position: absolute;
			top: -25px;
			left: 50%;
			transform: translate(-50%);
		}
		#tank:after{
			content: "";
			box-sizing: border-box;
			display: block;
			height: 60px;
			width: 60px;
			background: yellow;
			border: 2px solid #4d4f4f;
			border-radius: 100%;
			position: absolute;
		}
	.bullet{
		height: 30px;
		width: 30px;
		border-radius: 100%;
		background: #00abd8;
		position: absolute;
		border: 2px solid #4d4f4f;
	}
</style>
<script>
let tank = document.querySelector("#tank");
let positionX = document.body.scrollWidth / 2 - 30;
let positionY = document.body.scrollHeight / 2 - 30;
tank.style.left = positionX + "px";
tank.style.top = positionY + "px";

let wKeyPressed = false;
let sKeyPressed = false;
let aKeyPressed = false;
let dKeyPressed = false;

addEventListener("keydown", ()=>{//TANK MOVING
	if (event.code == "KeyW" && event.repeat == false){
		wKeyPressed = true;
		let speed = 1;
		let permittedSpeed = aKeyPressed || dKeyPressed ? 2.5 : 3.5;
		let speedIncrease = setInterval(()=>{
			if (speed < 2.5){
				speed += 0.5;
			}else if(speed >= 2.5 && speed < permittedSpeed){
				speed += 0.25;
			}
			else if(speed > permittedSpeed){
				speed -= 0.25;
			}
		},75);
		let timer = setInterval(()=>{
			aKeyPressed || dKeyPressed ? permittedSpeed = 2.5 : permittedSpeed = 3.5;
			if (positionY > 0){
				positionY -= speed;
			}else{
				positionY += 10;
				speed = 0;
			}
			tank.style.top = positionY + "px";
		},10);
		addEventListener("keyup", function keyup(){
			if (event.code == "KeyW"){
				wKeyPressed = false;
				clearInterval(speedIncrease);
				let speedDecrease = setInterval(()=>{
					if (speed > 1){
						speed -= 0.5;
					}else{
						clearInterval(speedDecrease);
						clearInterval(timer);
					}
				},75);
				removeEventListener("keyup", keyup);
			}
		})
	}
	if (event.code == "KeyS" && event.repeat == false){
		sKeyPressed = true;
		let speed = 1;
		let permittedSpeed = aKeyPressed || dKeyPressed ? 2.5 : 3.5;
		let speedIncrease = setInterval(()=>{
			if (speed < 2.5){
				speed += 0.5;
			}else if(speed >= 2.5 && speed < permittedSpeed){
				speed += 0.25;
			}
			else if(speed > permittedSpeed){
				speed -= 0.25;
			}
		},75);
		let timer = setInterval(()=>{
			aKeyPressed || dKeyPressed ? permittedSpeed = 2.5 : permittedSpeed = 3.5;
			if (positionY < document.body.scrollHeight - 60){
				positionY += speed;
			}else{
				positionY -= 10;
				speed = 0;
			}
			tank.style.top = positionY + "px";
		},10);
		addEventListener("keyup", function keyup(){
			if (event.code == "KeyS"){
				sKeyPressed = false;
				clearInterval(speedIncrease);
				let speedDecrease = setInterval(()=>{
					if (speed > 1){
						speed -= 0.5;
					}else{
						clearInterval(speedDecrease);
						clearInterval(timer);
					}
				},75);
				removeEventListener("keyup", keyup);
			}
		})
	}
	if (event.code == "KeyA" && event.repeat == false){
		aKeyPressed = true;
		let speed = 1;
		let permittedSpeed = wKeyPressed || sKeyPressed ? 2.5 : 3.5;
		let speedIncrease = setInterval(()=>{
			if (speed < 2.5){
				speed += 0.5;
			}else if(speed >= 2.5 && speed < permittedSpeed){
				speed += 0.25;
			}
			else if(speed > permittedSpeed){
				speed -= 0.25;
			}
		},75);
		let timer = setInterval(()=>{
			wKeyPressed || sKeyPressed ? permittedSpeed = 2.5 : permittedSpeed = 3.5;
			if (positionX > 0){
				positionX -= speed;
			}else{
				positionX += 10;
				speed = 0;
			}
			tank.style.left = positionX + "px";
		},10);
		addEventListener("keyup", function keyup(){
			if (event.code == "KeyA"){
				aKeyPressed = false;
				clearInterval(speedIncrease);
				let speedDecrease = setInterval(()=>{
					if (speed > 1){
						speed -= 0.5;
					}else{
						clearInterval(speedDecrease);
						clearInterval(timer);
					}
				},75);
				removeEventListener("keyup", keyup);
			}
		})
	}
	if (event.code == "KeyD" && event.repeat == false){
		dKeyPressed = true;
		let speed = 1;
		let permittedSpeed = wKeyPressed || sKeyPressed ? 2.5 : 3.5;
		let speedIncrease = setInterval(()=>{
			if (speed < 2.5){
				speed += 0.5;
			}else if(speed >= 2.5 && speed < permittedSpeed){
				speed += 0.25;
			}
			else if(speed > permittedSpeed){
				speed -= 0.25;
			}
		},75);
		let timer = setInterval(()=>{
			wKeyPressed || sKeyPressed ? permittedSpeed = 2.5 : permittedSpeed = 3.5;
			if (positionX < document.body.scrollWidth - 60){
				positionX += speed;
			}else{
				positionX -= 10;
				speed = 0;
			}
			tank.style.left = positionX + "px";
		},10);
		addEventListener("keyup", function keyup(){
			if (event.code == "KeyD"){
				dKeyPressed = false;
				clearInterval(speedIncrease)
				let speedDecrease = setInterval(()=>{
					if (speed > 1){
						speed -= 0.5;
					}else{
						clearInterval(speedDecrease);
						clearInterval(timer);
					}
				},75);
				removeEventListener("keyup", keyup);
			}
		})
	}
})


let x;
let y;
addEventListener("mousemove", rotate);
function rotate(){
	x = event.clientX - (parseInt(tank.style.left) + 30);
	y = event.clientY - (parseInt(tank.style.top) + 30);
	let r = 90 - 180 / Math.PI * -Math.atan2(y, x);
	tank.style.transform = `rotate(${r}deg`;
}

addEventListener("mousedown", ()=>{
	if (event.which == 1){
		shooting();
	}
});
addEventListener("keydown", ()=>{
	if (event.code == "Space"){
		shooting();
	}
});

let shotPermission = true;
let reload = 500;
let bulletSpeed = 7;
let enemySpeed = 1;

function shooting(){
	let gunBurst = setInterval(()=>{
		if (shotPermission){
			startShoot();
		}
	},0)
	addEventListener("mouseup", ()=>{
		clearInterval(gunBurst);
	})
	addEventListener("keyup", ()=>{
		if (event.code == "Space"){
			clearInterval(gunBurst);
		}
	})
	function startShoot(){
		shotPermission = false;
		setTimeout(()=>{
			shotPermission = true;
		},reload)
		let bullet = document.createElement("div");
		bullet.className = "bullet";
		let left = parseInt(tank.style.left) + 15;
		let top = parseInt(tank.style.top) + 15;
		bullet.style.left = left + "px";
		bullet.style.top = top + "px";
		document.body.prepend(bullet);

		let bulletTeleport = true;
		let currentBulletSpeed = bulletSpeed * 2;
		if (x >= 0 && y >= 0){
			if (x >= y){
				let coefSmall = y / x;
				let timer = setInterval(()=>{
					if (currentBulletSpeed > bulletSpeed){
						currentBulletSpeed *= 0.99;
					}
					if (bulletTeleport){
						for(let i = 0; i < 30 / bulletSpeed; i++){
							left += getNormalSpeed(currentBulletSpeed, coefSmall);
							top += getCoefsmallSpeed(currentBulletSpeed, coefSmall);
						}
						bulletTeleport = false;
					}else{
						left += getNormalSpeed(currentBulletSpeed, coefSmall);
						top += getCoefsmallSpeed(currentBulletSpeed, coefSmall);
					}
					bullet.style.left = left + "px";
					bullet.style.top = top + "px";

					if (left < -30 || top < -30 || left > document.body.scrollWidth || top > document.body.scrollHeight){
						clearInterval(timer)
						bullet.remove();
					}
				}, 10);
			}else{
				let coefSmall = x / y;
				let timer = setInterval(()=>{
					if (currentBulletSpeed > bulletSpeed){
						currentBulletSpeed *= 0.99;
					}
					if (bulletTeleport){
						for(let i = 0; i < 30 / bulletSpeed; i++){
							left += getCoefsmallSpeed(currentBulletSpeed, coefSmall);
							top += getNormalSpeed(currentBulletSpeed, coefSmall);
						}
						bulletTeleport = false;
					}else{
						left += getCoefsmallSpeed(currentBulletSpeed, coefSmall);
						top += getNormalSpeed(currentBulletSpeed, coefSmall);
					}
					bullet.style.left = left + "px";
					bullet.style.top = top + "px";

					if (left < -30 || top < -30 || left > document.body.scrollWidth || top > document.body.scrollHeight){
						clearInterval(timer)
						bullet.remove();
					}
				}, 10);
			}
		}else if (x < 0 && y >= 0){
			if (-x >= y){
				let coefSmall = y / -x;
				let timer = setInterval(()=>{
					if (currentBulletSpeed > bulletSpeed){
						currentBulletSpeed *= 0.99;
					}
					if (bulletTeleport){
						for(let i = 0; i < 30 / bulletSpeed; i++){
							left -= getNormalSpeed(currentBulletSpeed, coefSmall);
							top += getCoefsmallSpeed(currentBulletSpeed, coefSmall);
						}
						bulletTeleport = false;
					}else{
						left -= getNormalSpeed(currentBulletSpeed, coefSmall);
						top += getCoefsmallSpeed(currentBulletSpeed, coefSmall);
					}
					bullet.style.left = left + "px";
					bullet.style.top = top + "px";

					if (left < -30 || top < -30 || left > document.body.scrollWidth || top > document.body.scrollHeight){
						clearInterval(timer)
						bullet.remove();
					}
				}, 10);
			}else{
				let coefSmall = -x / y;
				let timer = setInterval(()=>{
					if (currentBulletSpeed > bulletSpeed){
						currentBulletSpeed *= 0.99;
					}
					if (bulletTeleport){
						for(let i = 0; i < 30 / bulletSpeed; i++){
							left -= getCoefsmallSpeed(currentBulletSpeed, coefSmall);
							top += getNormalSpeed(currentBulletSpeed, coefSmall);
						}
						bulletTeleport = false;
					}else{
						left -= getCoefsmallSpeed(currentBulletSpeed, coefSmall);
						top += getNormalSpeed(currentBulletSpeed, coefSmall);
					}
					bullet.style.left = left + "px";
					bullet.style.top = top + "px";

					if (left < -30 || top < -30 || left > document.body.scrollWidth || top > document.body.scrollHeight){
						clearInterval(timer)
						bullet.remove();
					}
				}, 10);
			}
		}else if (x < 0 && y < 0){
			if (-x >= -y){
				let coefSmall = -y / -x;
				let timer = setInterval(()=>{
					if (currentBulletSpeed > bulletSpeed){
						currentBulletSpeed *= 0.99;
					}
					if (bulletTeleport){
						for(let i = 0; i < 30 / bulletSpeed; i++){
							left -= getNormalSpeed(currentBulletSpeed, coefSmall);
							top -= getCoefsmallSpeed(currentBulletSpeed, coefSmall);
						}
						bulletTeleport = false;
					}else{
						left -= getNormalSpeed(currentBulletSpeed, coefSmall);
						top -= getCoefsmallSpeed(currentBulletSpeed, coefSmall);
					}
					bullet.style.left = left + "px";
					bullet.style.top = top + "px";

					if (left < -30 || top < -30 || left > document.body.scrollWidth || top > document.body.scrollHeight){
						clearInterval(timer)
						bullet.remove();
					}
				}, 10);
			}else{
				let coefSmall = -x / -y;
				let timer = setInterval(()=>{
					if (currentBulletSpeed > bulletSpeed){
						currentBulletSpeed *= 0.99;
					}
					if (bulletTeleport){
						for(let i = 0; i < 30 / bulletSpeed; i++){
							left -= getCoefsmallSpeed(currentBulletSpeed, coefSmall);
							top -= getNormalSpeed(currentBulletSpeed, coefSmall);
						}
						bulletTeleport = false;
					}else{
						left -= getCoefsmallSpeed(currentBulletSpeed, coefSmall);
						top -= getNormalSpeed(currentBulletSpeed, coefSmall);
					}
					bullet.style.left = left + "px";
					bullet.style.top = top + "px";

					if (left < -30 || top < -30 || left > document.body.scrollWidth || top > document.body.scrollHeight){
						clearInterval(timer)
						bullet.remove();
					}
				}, 10);
			}
		}else{
			if (x >= -y){
				let coefSmall = -y / x;
				let timer = setInterval(()=>{
					if (currentBulletSpeed > bulletSpeed){
						currentBulletSpeed *= 0.99;
					}
					if (bulletTeleport){
						for(let i = 0; i < 30 / bulletSpeed; i++){
							left += getNormalSpeed(currentBulletSpeed, coefSmall);
							top -= getCoefsmallSpeed(currentBulletSpeed, coefSmall);
						}
						bulletTeleport = false;
					}else{
						left += getNormalSpeed(currentBulletSpeed, coefSmall);
						top -= getCoefsmallSpeed(currentBulletSpeed, coefSmall);
					}
					bullet.style.left = left + "px";
					bullet.style.top = top + "px";

					if (left < -30 || top < -30 || left > document.body.scrollWidth || top > document.body.scrollHeight){
						clearInterval(timer)
						bullet.remove();
					}
				}, 10);
			}else{
				let coefSmall = x / -y;
				let timer = setInterval(()=>{
					if (currentBulletSpeed > bulletSpeed){
						currentBulletSpeed *= 0.99;
					}
					if (bulletTeleport){
						for(let i = 0; i < 30 / bulletSpeed; i++){
							left += getCoefsmallSpeed(currentBulletSpeed, coefSmall);
							top -= getNormalSpeed(currentBulletSpeed, coefSmall);
						}
						bulletTeleport = false;
					}else{
						left += getCoefsmallSpeed(currentBulletSpeed, coefSmall);
						top -= getNormalSpeed(currentBulletSpeed, coefSmall);
					}
					bullet.style.left = left + "px";
					bullet.style.top = top + "px";

					if (left < -30 || top < -30 || left > document.body.scrollWidth || top > document.body.scrollHeight){
						clearInterval(timer)
						bullet.remove();
					}
				}, 10);
			}
		}
		function getCoefsmallSpeed(currentBulletSpeed, coefSmall){
			return ((currentBulletSpeed * coefSmall) / 2) + (((currentBulletSpeed * coefSmall) / 2) * (1 - coefSmall));
		}
		function getNormalSpeed(currentBulletSpeed, coefSmall){
			return (currentBulletSpeed / 2) + ((currentBulletSpeed / 2) * (1 - coefSmall));
		}
	}
}



///SQUARES



let allDivs = [];


createBox();
setInterval(()=>{
	if (allDivs.length < 10){
		createBox();
	}
},1000)
function createBox(){
	let box = document.createElement("div");
	box.className = "enemy";
	allDivs.push(box);

	let anotherDivs = [];
	let anotherDivsMonitoring = setInterval(()=>{
		let buffer = [];
		for (let i in allDivs){
			buffer.push(allDivs[i]);
		}
		for (let i in buffer){
			if (buffer[i] == box){
				buffer.splice(i,1);
			}
		}
		anotherDivs = buffer;
	},0)


	//SPAWN BOX ON MAP
	let spawnerX;
	let spawnerY;
	if (Math.random() > 0.5){
		if (Math.random() > 0.5){
			spawnerX = -100;
		}else{
			spawnerX = document.body.scrollWidth + 40;
		}
		spawnerY = Math.floor((Math.random() * document.body.scrollHeight));
	}else{
		spawnerX = Math.floor((Math.random() * document.body.scrollWidth));
		if (Math.random() > 0.5){
			spawnerY = -100;
		}else{
			spawnerY = document.body.scrollHeight + 40;
		}
	}


	box.style.left = `${spawnerX}px`;
	box.style.top = `${spawnerY}px`;
	document.body.append(box);

	//CHOSE MOVING DIRECTION
	let directionX = Math.random() > 0.5 ? "right" : "left";
	let directionY = Math.random() > 0.5 ? "up" : "down";


	//START MOVING
	let boxPosition = {left: spawnerX, top: spawnerY};
	let movingTimer = setInterval(()=>{
		moving();
	},10);

	function moving(){
		let anotherDivsPosition = [];
		for (let i in anotherDivs){
			anotherDivsPosition.push({left: parseInt(anotherDivs[i].style.left), top: parseInt(anotherDivs[i].style.top)});
		};
		directionX = checkDirectionX();
		directionY = checkDirectionY();


		function checkDirectionX(){
			if (directionX == "right"){
				if (boxPosition.left >= (document.body.scrollWidth - 80)){
					return "left";
				}else{
					for (let i in anotherDivsPosition){
						if (boxPosition.left + 81 >= anotherDivsPosition[i].left && boxPosition.left + 81 <= anotherDivsPosition[i].left + 5){
							if (boxPosition.top > anotherDivsPosition[i].top - 80 && boxPosition.top < anotherDivsPosition[i].top + 80){
								return "left";
							}
						}
					}
					return "right";
				}
			}else if(directionX == "left"){
				if (boxPosition.left <= 0){
					return "right";
				}else{
					for (let i in anotherDivsPosition){
						if (anotherDivsPosition[i].left + 81 >= boxPosition.left && anotherDivsPosition[i].left + 81 <= boxPosition.left + 5){
							if (boxPosition.top > anotherDivsPosition[i].top - 80 && boxPosition.top < anotherDivsPosition[i].top + 80){
								return "right";
							}
						}
					}
					return "left";
				}
			}
		}
		function checkDirectionY(){
			if (directionY == "down"){
				if (boxPosition.top >= (document.body.scrollHeight - 80)){
					return "up";
				}else{
					for (let i in anotherDivsPosition){
						if (boxPosition.top + 81 >= anotherDivsPosition[i].top && boxPosition.top + 81 < anotherDivsPosition[i].top + 5){
							if (boxPosition.left > anotherDivsPosition[i].left - 80 && boxPosition.left < anotherDivsPosition[i].left + 80){
								return "up";
							}
						}
					}
					return "down";
				}
			}else if(directionY == "up"){
				if (boxPosition.top <= 0){
					return "down";
				}else{
					for (let i in anotherDivsPosition){
						if (anotherDivsPosition[i].top + 81 >= boxPosition.top && anotherDivsPosition[i].top + 81 <= boxPosition.top + 5){
							if (boxPosition.left > anotherDivsPosition[i].left - 80 && boxPosition.left < anotherDivsPosition[i].left + 80){
								return "down";
							}
						}
					}
					return "up";
				}
			}
		}
		setTimeout(()=>{
			//X MOVING
			if (directionX == "right"){
				boxPosition.left += enemySpeed;
				box.style.left = `${boxPosition.left}px`;
			}else if(directionX == "left"){
				boxPosition.left -= enemySpeed;
				box.style.left = `${boxPosition.left}px`;
			}
			//Y MOVING
			if (directionY == "down"){
				boxPosition.top += enemySpeed;
				box.style.top = `${boxPosition.top}px`;
			}else if(directionY == "up"){
				boxPosition.top -= enemySpeed;
				box.style.top = `${boxPosition.top}px`;
			}
		}, 0);

		if (Math.random() < 0.0002){
			clearInterval(anotherDivsMonitoring);
			clearInterval(movingTimer);
			for (let i in allDivs){
				if (allDivs[i] == box){
					allDivs.splice(i,1);
				}
			}
			box.remove();
		}
	}
}
</script>
</html>